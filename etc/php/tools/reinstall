#!/bin/bash

shopt -s extglob
dir=$(basename $(pwd))

ver=${1:-'ce'}
#TODO: remove
DB=${2:-'magento'}
#TODO: remove
HOST_DB=${3:-'db'}
HOST=${4:-'magento.test'}

if [[ -d .git ]]; then
   git clean -dfx --exclude='.idea' $(mount | grep -oP '/var/www/magento2ce/\K\S*' | xargs -n 1 echo '-e ')
   git checkout composer.lock composer.json
fi

if [[ ${ver} = 'ee' ]] || [[ ${ver} = 'b2b' ]]; then
   cp -rlf ../magento2ee/!(.git|vendor|..|.) .
fi

if [[ ${ver} = 'b2b' ]]; then
   cp -rlf ../magento2b2b/!(.git|vendor|..|.) .
fi

composer install

bin/magento setup:install \
   --cleanup-database \
   --language=en_US \
   --timezone=Europe/Kiev \
   --currency=USD \
   --use-secure=0 \
   --use-secure-admin=0 \
   --admin-use-security-key=0 \
   --backend-frontname=admin \
   --admin-lastname=Admin \
   --admin-firstname=Admin \
   --admin-email=magento@mailinator.com \
   --admin-user=admin \
   --admin-password=123123q \
   --base-url=http://$HOST/ \
   --db-name=$DB \
   --db-host=$HOST_DB \
   --db-prefix=m2_

bin/magento config:set web/seo/use_rewrites 1
bin/magento config:set dev/template/allow_symlink 1
bin/magento config:set admin/security/admin_account_sharing 1
bin/magento config:set admin/security/session_lifetime 31536000

#setup other services
IFS=$'\n' setup=($(yq read /var/www/magento-docker/docker-compose.yml services.*.x-setup | grep -oP '(?:\-\s)+(?!null)\K.*'))
for i in ${setup[*]}; do eval ${i}; done